<apex:page controller="ERDGeneratorController">
	<style type="text/css">
        .textInput {width: 100%;}
	    .pbTitle {white-space: nowrap}
	    #titleContainer {margin: 5px 0px;}
	    #generatorTitle {margin-left: 22px; font-size:1.5em;}
	    .throbber {
	    	padding-left: 20px;
	    	margin: 0 10px; 
	    	font-size: 1.1em;
	    	background: url("{!$Resource.WorkingImage}") no-repeat;}
	    #generatingLabel {
	    	margin: 5px 5px;
	    }
	    #generateContainer > * {
	    	float:left;
	    	margin: 0 5px 2px 0;
	    }
	    #dropboxFileSelected {
	    	padding: 2px 0 0 0;
	    	font-weight: bold;
	    }
	    #download {
	    	float: right;
	    }
    </style>
    
   	<apex:messages />
    
    <apex:form id="generatorForm">
    	<apex:pageBlock id="generatorBlock">
     		<apex:facet name="header">
    			<apex:outputPanel id="title">
    				<div id="titleContainer">
	    				<h2 id="generatorTitle">Diagram: {!currentSetting}</h2>
	    				<apex:actionStatus id="working">
	    					<apex:facet name="start">
	    						<span id="workingLabel" class="throbber">Working..</span>
	    					</apex:facet>
	    				</apex:actionStatus>
    				</div>
    			</apex:outputPanel>
    		</apex:facet>
            <apex:pageBlockSection columns="3">
			    <apex:pageBlock title="Step 1 - ERD Diagram" id="blockSetting">
                	<apex:pageBlockSection >
                		<apex:selectList id="settingPicklist" value="{!selectedSetting}" 
                			size="1" style="width:150px;">
				            <apex:actionSupport event="onchange" action="{!loadSelectedSetting}" rerender="blockGroup,blockSelection,title" status="working" />
				            <apex:selectOptions value="{!settingSelectOptions}"/>
				        </apex:selectList>
				        <apex:panelGroup >
                    	<apex:commandButton id="btnDeleteSetting" value="Delete" 
                    		action="{!deleteSelectedSetting}" rerender="blockSetting,blockGroup,blockSelection,title" 
                    		status="working" style="width:40px;">
                    	</apex:commandButton>
                    	<apex:commandButton id="btnSaveSetting" value="Save" 
                    		action="{!saveSelectedSetting}" rerender="title" 
                    		status="working" style="width:40px;">
                    	</apex:commandButton>
                    	</apex:panelGroup>
                		<apex:outputText value="OR" />
                    	<br />
                		<apex:inputText id="inpSettingName" styleClass="textInput" value="{!newSettingName}" />
                    	<apex:commandButton id="btnSaveNewSetting" value="Save as New" 
                    		action="{!saveAsNewSetting}" rerender="settingPicklist,title" status="working">
                    		<apex:param value="{!newSettingName}"/>
                    	</apex:commandButton>
                	</apex:pageBlockSection>
                </apex:pageBlock>
                <apex:pageBlock title="Step 2 - Groups in Diagram" id="blockGroup">
                	<apex:pageBlockSection >
                    	<apex:inputText id="inpGroupName" styleClass="textInput" value="{!newGroupName}" />
                    	<apex:commandButton id="btnCreateGroup" value="Add" 
                    		action="{!addNewGroupWithInput}" rerender="groupTable" status="working">
                    	</apex:commandButton>
                	</apex:pageBlockSection>
                	<apex:pageBlockTable id="groupTable" value="{!ERDGroupList}" var="group">
				    	<apex:column headerValue="Select Groups">
				        	<apex:inputCheckbox id="groupCheckBox" value="{!group.selected}">
					        	<!-- <apex:actionSupport event="onchange" rerender="selectedGroupPicklist"/> -->
				        	</apex:inputCheckbox>
				    		<apex:outputLabel value="{!group.groupName}" for="groupCheckBox" />
				        </apex:column>
				        <apex:column headerValue="Edit" width="30">
				        	<apex:commandButton id="editGroupButton" value="Edit >>" rerender="blockSelection" status="working">
					        	<apex:param assignTo="{!selectedGroup}" value="{!group.groupName}" name="selectedERDGroup"/>
				        	</apex:commandButton>
				        </apex:column>
				        <apex:column headerValue="Delete" width="30">
				        	<apex:commandButton id="deleteGroupButton" value="Delete" action="{!deleteERDGroup}" rerender="blockGroup,blockSelection" status="working">
				        		<apex:param assignTo="{!groupToDelete}" value="{!group.groupName}" name="ERDGroupToDelete"/>
				        	</apex:commandButton>
				        </apex:column>
				    </apex:pageBlockTable>
                </apex:pageBlock>
                
                <apex:pageBlock title="Step 3 - Edit Group: {!selectedGroup}" id="blockSelection">
		            <apex:panelGrid columns="3">
		            	<apex:panelGroup >
		            		<div style="height:12px;">
		            		<apex:outputText value="Available Objects" />
		            		</div>
		            		<br />
		            		<apex:selectList id="unselected_list" required="false"
			                    value="{!selected}" multiselect="true" size="20" style="width:250px;">
			                    <apex:selectOptions value="{!unSelectedOptions}"/>
			                </apex:selectList>
		            	</apex:panelGroup>
		                <apex:panelGroup >
		                	<br />
		                	<br />
		                	<br />
		                	<br />
		                	<br />
		                    <apex:commandButton value=">>" action="{!DoSelect}" 
		                        reRender="blockSelection" status="working"/>
		                    <br/>
		                    <apex:commandButton value="<<" action="{!DoUnselect}" 
		                        reRender="blockSelection" status="working"/>
		                </apex:panelGroup>
		                <apex:panelGroup >
	                		<div style="height:12px;">
		            		<apex:outputText value="Included Objects" />
		            		</div>
		            		<br />
			                <apex:selectList id="selected_list" required="false"
			                    value="{!unselected}" multiselect="true" size="20" style="width:250px;">
			                    <apex:selectOptions value="{!selectedOptions}"/>
			                </apex:selectList>
		                </apex:panelGroup>
		            </apex:panelGrid>
		        </apex:pageBlock>
            </apex:pageBlockSection>
            <div>
				<h2>ERD Content</h2>
			    <div id="generateContainer">
		    		<apex:commandButton value="Generate" action="{!generateERD}" 
		    			rerender="contentTextArea" status="generating"/>
			    	<apex:selectList id="template" size="1" value="{!template}" 
			    		onChange="templateChanged();">
			    		<apex:selectOptions value="{!templates}"/>
			    	</apex:selectList>
			    	<span id="dropboxFileSelected"/>
			    	<span id="pickDropboxContainer"/>
		    		<apex:inputHidden id="fileURL" value="{!fileURL}" />
			    	<a id="download" target="download">Download Template</a>
			    </div>
			    <div style="clear: both;"/>
			    <div>
				    <apex:actionStatus id="generating">
	   					<apex:facet name="start">
	   						<div id="generatingLabel" class="throbber">Generating..</div>
	   					</apex:facet>
	   				</apex:actionStatus>			    
	   			</div>
               	<apex:inputTextarea id="contentTextArea" value="{!generatedContent}" 
               		rows="20" style="width:100%;" />
            </div>
        </apex:pageBlock>
    </apex:form>

	<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.js" 
		type="text/javascript"></script>
	<script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.10.4/jquery-ui.js" 
		type="text/javascript"></script>
    <script type="text/javascript" src="https://www.dropbox.com/static/api/2/dropins.js" 
    	id="dropboxjs" data-app-key="1nasijgpqxbicyu"></script>
    <script type="text/javascript">
    	var globals = {
    		fields: {
    			fileURL:  "{!$Component.generatorForm.generatorBlock.fileURL}",
    			template: "{!$Component.generatorForm.generatorBlock.template}"
    		},
    		templates: {
    			"DefaultTemplate" : "{!$Resource.DefaultTemplate}"
    		}
    	};
    </script>
    <script type="text/javascript" src="{!$Resource.ERDGeneratorJS}"></script>

</apex:page>